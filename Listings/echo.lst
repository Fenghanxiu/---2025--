C51 COMPILER V9.60.0.0   ECHO                                                              04/05/2025 13:11:54 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE ECHO
OBJECT MODULE PLACED IN .\Objects\echo.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE echo.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\echo
                    -.lst) OBJECT(.\Objects\echo.obj)

line level    source

   1          #include "echo.h"
   2          
   3          sbit trig=P1^0;   //¶¨Òå·¢ËÍ¶Ë
   4          sbit echo=P1^1;   //¶¨Òå½ÓÊÕ¶Ë
   5          //PCA¼ÆÊ±°æ±¾
   6          void Delay14us()                //@12.000MHz
   7          {
   8   1              unsigned char i;
   9   1      
  10   1              _nop_();
  11   1              _nop_();
  12   1              i = 39;
  13   1              while (--i);
  14   1      }
  15          
  16          void send_wave()
  17          {
  18   1              unsigned char i=0;
  19   1              EA=0;
  20   1              for(i=0;i<8;i++)
  21   1              {
  22   2                      trig=1;Delay14us();
  23   2                      trig=0;Delay14us();
  24   2              }
  25   1              EA=1;
  26   1      }
  27          unsigned int xdata distance=0;
  28          void Get_distance()
  29          {
  30   1              CMOD=0x00;
  31   1              CH=0;
  32   1              CL=0;
  33   1              send_wave();
  34   1              CR=1;
  35   1              while((CF==0)&&(echo==1));
  36   1              CR=0;
  37   1              if(!CF)
  38   1              {
  39   2                      distance=(unsigned int)(CH<<8|CL)*0.017;//cm
  40   2              }
  41   1              else
  42   1              {
  43   2                      CF=0;
  44   2                      distance=0;
  45   2              }
  46   1      }
  47          
  48          //PCAÖÐ¶Ï
  49          
  50          void PCAInit()
  51          {
  52   1              CCON=0x00;
  53   1              CMOD=0x01;
  54   1              CCAPM0=0x11;
C51 COMPILER V9.60.0.0   ECHO                                                              04/05/2025 13:11:54 PAGE 2   

  55   1      }
  56          
  57          unsigned char xdata echo_flag=0;
  58          //unsigned int xdata distance=0;
  59          
  60          /* ultrasonic_flag ³¬Éù²¨×´Ì¬±êÖ¾
  61                   0£º¿ÕÏÐ½×¶Î
  62                   1£º·¢ËÍ½×¶Î
  63                   2£ºÈ·ÈÏ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨
  64                   3£º½ÓÊÕ²»µ½³¬Éù²¨£¬»ò³¬³öÁ¿³Ì */
  65          void TimerPCAIsr() interrupt 7
  66          {
  67   1              CR=0;
  68   1              
  69   1              if(echo_flag==1)//µ±´¦ÓÚ·¢ËÍ½×¶Î
  70   1              {
  71   2                      if(CCF0==1)/* ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨ */
  72   2                      {
  73   3                              echo_flag=2;//È·ÈÏ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨
  74   3                      }
  75   2                      else if(CF==1)//½ÓÊÕ²»µ½³¬Éù²¨£¬»ò³¬³öÁ¿³Ì
  76   2                      {
  77   3                              echo_flag=3;//ÒâÍâÇé¿ö
  78   3                      }
  79   2                      else
  80   2                      {
  81   3                              echo_flag=0;
  82   3                      }
  83   2              }
  84   1              
  85   1              CF=0;
  86   1              CCF0=0;
  87   1              CCF1=0;//ÕâÁ½¸ö±êÖ¾Î»ËäÈ»Ã»ÓÐÓÃµ½
  88   1              CCF2=0;//µ«ÊÇÒÔ·ÀÍòÒ»£¬µ¼ÖÂÖÐ¶Ï¿¨×¡
  89   1      }
  90          
  91          /* ³¬Éù²¨·¢ËÍ */
  92          void sand_ultrasonic()
  93          { 
  94   1              unsigned char i=0;
  95   1              //¼ÆÊ±ÔÚÇ°»¹ÊÇ·¢ËÍÔÚÇ°¶¼¿ÉÒÔ£¬ÔÚÎÒµÄ°å×ÓÉÏÎÒ·¢ÏÖ¼ÆÊ±ÔÚÇ°µÄÊý¾Ý±È½Ï×¼È·
  96   1              CH=0;
  97   1              CL=0;
  98   1              CF=0;
  99   1              
 100   1              EA=0;
 101   1              CR=1;
 102   1              for(i=0;i<8;i++)
 103   1              {
 104   2                      trig=1;Delay14us();
 105   2                      trig=0;Delay14us();
 106   2              }
 107   1              
 108   1              EA=1;
 109   1              
 110   1      }
 111          
 112          void calc_echo()
 113          {
 114   1              if(echo_flag==2)
 115   1              {
 116   2                      distance=(unsigned int)(CCAP0H<<8|CCAP0L)*0.017;//cm
C51 COMPILER V9.60.0.0   ECHO                                                              04/05/2025 13:11:54 PAGE 3   

 117   2              }
 118   1              else
 119   1              {
 120   2                      distance=0;
 121   2              }
 122   1      }
 123          
 124          void read_echo()
 125          {
 126   1              if(echo_flag>0)
 127   1              {
 128   2                      calc_echo();
 129   2                      echo_flag=0;
 130   2              }
 131   1              
 132   1              if(echo_flag==0)
 133   1              {
 134   2                      sand_ultrasonic();
 135   2                      echo_flag=1;
 136   2              }
 137   1      }
 138          
 139          ///* Èç¹ûÄã·¢ÏÖ²â¾àµÄÁ¿³ÌºÜ¶Ì£¬ÄÇÄãÓ¦¸Ã¿´¿´
 140          //       ÏÂÔØµÄÊ±ºòIRCÆµÂÊÓÐÃ»ÓÐµ÷³É12.000MHz£¬
 141          //       ¶ø²»ÊÇÀ´ÖÊÒÉÎÒµÄ´úÂë (>w<) */
 142          //void Delay13us()              //@12.000MHz
 143          //{
 144          //      unsigned char i;
 145          
 146          //      _nop_();
 147          //      _nop_();
 148          //      i = 39;
 149          //      while (--i);
 150          //}
 151          
 152          //void TimerPCAInit()
 153          //{
 154          //      CCON = 0;       //³õÊ¼»¯PCA¿ØÖÆ¼Ä´æÆ÷
 155          //                                              //PCA¶¨Ê±Æ÷Í£Ö¹
 156          //                                              //Çå³ýCF±êÖ¾
 157          //                                              //Çå³ýÄ£¿éÖÐ¶Ï±êÖ¾
 158          //      CMOD = 0x01;            //ÉèÖÃPCAÊ±ÖÓÔ´ 1MHz
 159          //                                                                      //¿ªÆôPCA¶¨Ê±Æ÷Òç³öÖÐ¶Ï
 160          //      CCAPM0 = 0x11;  //PCAÄ£¿é0ÎªÏÂ½µÑØ´¥·¢
 161          //                                                                      //ÀûÓÃÂö³å²¶»ñÀ´Ä£ÄâP11ÏÂ½µÑØÍâ²¿ÖÐ¶Ï
 162          //}
 163          
 164          ///* ultrasonic_flag ³¬Éù²¨×´Ì¬±êÖ¾
 165          //       0£º¿ÕÏÐ½×¶Î
 166          //       1£º·¢ËÍ½×¶Î
 167          //       2£ºÈ·ÈÏ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨
 168          //       3£º½ÓÊÕ²»µ½³¬Éù²¨£¬»ò³¬³öÁ¿³Ì */
 169          //unsigned char ultrasonic_flag = 0;
 170          
 171          
 172          ///* P11£¬¼´³¬Éù²¨RX£¬Ò»µ©³öÏÖÏÂ½µÑØ£¬
 173          //       ÔòËµÃ÷ÒÑ¾­ÊÕµ½·µ»ØµÄ³¬Éù²¨£¬½øÈë´ËÖÐ¶Ï */
 174          //void TimerPCAIsr() interrupt 7
 175          //{
 176          //      CR = 0; //ÓÅÏÈ½áÊø¼ÆÊ±
 177          //      
 178          //      if (ultrasonic_flag == 1) //µ±´¦ÓÚ·¢ËÍ½×¶Î
C51 COMPILER V9.60.0.0   ECHO                                                              04/05/2025 13:11:54 PAGE 4   

 179          //      {
 180          //              if (CCF0) /* ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨ */
 181          //                      ultrasonic_flag = 2; //È·ÈÏ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨
 182          //              else if (CF) /* ³¬³öÁ¿³Ì */
 183          //                      ultrasonic_flag = 3; //½ÓÊÕ²»µ½³¬Éù²¨£¬»ò³¬³öÁ¿³Ì
 184          //              else
 185          //                      ultrasonic_flag = 0; //ÒâÍâÇé¿ö
 186          //      }
 187          ////    else ÕâÀï±¾Ó¦¸Ã¼ÓÕâ¸öelse£¬µ«ÓÐbug£¬ÎÒÔÝÊ±ÕÒ²»µ½
 188          ////            ultrasonic_flag = 0; //ÒâÍâÇé¿ö
 189          //      
 190          //      CF = 0;
 191          //      CCF0 = 0;
 192          //      CCF1 = 0; //ÕâÁ½¸ö±êÖ¾Î»ËäÈ»Ã»ÓÐÓÃµ½
 193          //      CCF2 = 0; //µ«ÊÇÒÔ·ÀÍòÒ»£¬µ¼ÖÂÖÐ¶Ï¿¨×¡
 194          //}
 195          
 196          ///* ³¬Éù²¨·¢ËÍ */
 197          //void sand_ultrasonic()
 198          //{ //¼ÆÊ±ÔÚÇ°»¹ÊÇ·¢ËÍÔÚÇ°¶¼¿ÉÒÔ£¬ÔÚÎÒµÄ°å×ÓÉÏÎÒ·¢ÏÖ¼ÆÊ±ÔÚÇ°µÄÊý¾Ý±È½Ï×¼È·
 199          //      /* Æô¶¯¼ÆÊ± */
 200          //      CH = 0x8D;              //ÉèÖÃ¶¨Ê±³õÊ¼Öµ£¬Õâ¸öÖµÊÇÕâÃ´À´µÄ£º0x8D1C ¡Ö 65535 - 500£¨ÀåÃ×£© / 0.017£¨ÀåÃ×/Î¢Ãë£©£¬Ïë¸
             -ÄÁ¿³Ì¿ÉÒÔ×Ô¼ºËã
 201          //      CL = 0x1C;              //ÉèÖÃ¶¨Ê±³õÊ¼Öµ
 202          //      /* ¾­¹ý²âÊÔ£¬°å×ÓÄÜ²âµÄ×î³¤¾àÀëÊÇ4Ã×£¨ÖÁÉÙÎÒÕâ¿é°å×ÓÊÇÕâÑù£©£¬
 203          //               ¶ø¶¨Ê±Æ÷µÄÀíÂÛÁ¿³ÌÔ¶³¬4Ã×£¬ËùÒÔÉèÖÃ³õÖµµÄÒâÒåÔÚÓÚËõ¶ÌÁ¿³Ì
 204          //               £¨´ó¸ÅËõ¼õµ½5Ã×£©£¬ÒÔ´ËÀ´¼õÉÙ²»±ØÒªµÄ²âÁ¿Ê±¼ä£¬
 205          //               ËùÒÔ³¬Éù²¨´«²¥µÄÊ±¼ä¾ÍÊÇÖÕÖµ¼õ³õÖµ */
 206          //      CF = 0;         //Çå³ýCF±êÖ¾
 207          //      
 208          //      /* Æô¶¯³¬Éù²¨·¢ËÍ */
 209          //      EA = 0; //¹Ø±ÕÖÐ¶Ï£¬·ÀÖ¹´ò¶Ï·¢ËÍ
 210          //      CR = 1; //¶¨Ê±Æ÷¿ªÊ¼¼ÆÊ±
 211          //      P10 = 1; Delay13us(); P10 = 0; Delay13us(); //¸ßµçÆ½ÔÚÇ°µÍµçÆ½ÔÚºó
 212          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 213          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 214          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 215          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 216          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 217          //      P10 = 1; Delay13us(); P10 = 0; Delay13us();
 218          //      P10 = 1; Delay13us(); P10 = 0; //ÓÐÊ±ºò£¬×öÈËÒªÖ±½ÓÒ»µã£¨Ö¸Ö±½Ó¸´ÖÆ8´Î£©
 219          //      EA = 1; //ÖØÐÂ´ò¿ªÖÐ¶Ï
 220          //}
 221          
 222          ///* ¼ÆËã¾àÀë */
 223          //void calculate_distance()
 224          //{
 225          //      if (ultrasonic_flag == 2) //È·ÈÏ½ÓÊÕµ½·µ»ØµÄ³¬Éù²¨
 226          //      {
 227          ////            distance = CCAP0H;
 228          ////            distance <<= 8;
 229          ////            distance |= CCAP0L;
 230          ////            distance -= 0x8D1C; //¼õµô¶¨Ê±Æ÷³õÖµ£¬¼õÈ¥³õÖµÔ­ÒòÔÚÉèÖÃ³õÖµµÄµØ·½ÓÐ×¢½â
 231          ////            distance = (float)distance * 0.017;
 232          //              distance = ((CCAP0H << 8 | CCAP0L) - 0x8D1C) * 0.017;
 233          //      }
 234          //      else //½ÓÊÕ²»µ½³¬Éù²¨£¬»ò³¬³öÁ¿³Ì
 235          //      {
 236          //              //distance = DISTANCE_OUTRANG;
 237          //              distance = 0;
 238          //      }
 239          //}
C51 COMPILER V9.60.0.0   ECHO                                                              04/05/2025 13:11:54 PAGE 5   

 240          
 241          ///* ¶ÁÈ¡¾àÀëº¯Êý
 242          //       ²»Ò»¶¨ÐèÒªÕâÃ´Ð´
 243          //       ¿ÉÒÔ¸ü¾ÝÉÏÃæÁ½¸öº¯Êý×ÔÐÐÐÞ¸Ä */
 244          //void read_distance()
 245          //{ //¿ÉÄÜÄã»á¾õµÃÕâ¸öº¯ÊýÐ´µÄ²»ºÃ£¬µ«ÕâÓ¦¸ÃÊÇ×î¼òµ¥µÄÐ´·¨ÁË
 246          //      if (ultrasonic_flag > 1)
 247          //      {
 248          //              calculate_distance();
 249          //              ultrasonic_flag = 0; //½øÈë·¢ËÍ½×¶Î
 250          //      }
 251          //      
 252          //      if (ultrasonic_flag == 0)
 253          //      {
 254          //              sand_ultrasonic();
 255          //              ultrasonic_flag = 1; //½øÈë·¢ËÍ½×¶Î
 256          //      }
 257          //}


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    287    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
